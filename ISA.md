# ISA
## Регистры
### Регистры общего назначения
4 регистра размером в 12 бит, общего назначения:
* Регистер `A` имеет номер 0.
* Регистер `B` -- номер 1.
* Регистер `C` -- номер 2.
* Регистер `D` -- номер 3.

### Специальные регистры
2 регистра(12 бит):
* `SP` (Stack pointer). Это указатель на вершину стека.
* `PC` (Program counter). Это адресс в памяти который будет выполнен процесором следующим.

Регистер `Flags` 2-битный.
1. Первый бит -- это флаг нуля (`Zero flag`). Он установлен если результат прошлой арефметической операции был ноль.
2. Бит 2 -- это флаг переноса (`Carry flag`). Он устонавливается если во время выполнения арефметической операции был перенос или заем

## Стек
Стек начинается с аддреса 0xFFF и растет к малым адресам. При `PUSH A`:
* `SP--`
* `MEM\[SP\] = A`
При `POP A`
* `A = MEM\[SP\]`
* `SP++`

## Команды
### Формат команды
* 12 битный код команды. Состоит из:
  * Базовый код(8 бит)
  * Номер регистра 1(2 бит). Не для всех команд, там где неиспользуется -- 0
  * Номер регистра 2(2 бит). Не для всех команд, там где неиспользуется -- 0
* 12 битный Аргумент. Не для всех команд, там где неиспользуется отсутствует

Для каждой команды процесор делает следущее(пример):
* Берется код команды: `0x01D`
* `D` делятся на `R1`(Будет равен 3) и `R2`(Будет равен 1)
* `R1` -- регистер номер 3 -- регистер `D`
* `R2` -- регистер номер 1 -- регистер `B`
* `D += B`

### Таблица команд
V = Аргумент
ZF = `Zero flag`
CF = `Carry flag`

| Базовый код | Мнемоника   | Аргумент | Влияние на флаги | Влияние на регистры   | Действие команды (Порядок сдесь ОЧЕНЬ важен)  |
| ----------- | ----------- | -------- | ---------------- | --------------------- | --------------------------------------------- |
| 0x00        | NOP         | Нет      | Нет              | Нет                   | Ничего                                        |
| 0x01        | HLT         | Нет      | Нет              | Нет                   | Завершает работу процесора                    |
| 0x02        | AND R1, R2  | Нет      | ZF, CF           | R1                    | R1 &= R2; CF = 0                              |
| 0x03        | NOT R1      | Нет      | ZF, CF           | R1                    | R1 = ~R1; CF = 0                              |
| 0x04        | OR R1, R2   | Нет      | ZF, CF           | R1                    | R1 |= R2; CF = 0                              |
| 0x05        | XOR R1, R2  | Нет      | ZF, CF           | R1                    | R1 ^= R2; CF = 0                              |
| 0x06        | SHL R1      | Нет      | ZF, CF           | R1                    | CF = R1\[11\]; R1 <<= 1                       |
| 0x07        | SHR R1      | Нет      | ZF, CF           | R1                    | CF = R1\[0\]; R1 >>= 1 (Логический сдвиг)     |
| 0x08        | ADD R1, R2  | Нет      | ZF, CF           | R1                    | R1 += R2; CF = R1 < R2                        |
| 0x09        | SAR R1      | Нет      | ZF, CF           | R1                    | CF = R1\[0\]; R1 >>= 1 (Арефметический сдвиг) |
| 0x0A        | INC R1      | Нет      | ZF               | R1                    | R1 += 1                                       |
| 0x0B        | DEC R1      | Нет      | ZF               | R1                    | R1 -= 1                                       |
| 0x0C        | CMP R1, R2  | Нет      | ZF, CF           | Нет                   | CF = R1 < R2; R1 - R2                         |
| 0x0D        | CMP R1, V   | Да       | ZF, CF           | Нет                   | CF = R1 < V; R1 - V                           |
| 0x0E        | MOV R1, R2  | Нет      | Нет              | R1                    | R1 = R2                                       |
| 0x0F        | LDI R1, V   | Да       | Нет              | R1                    | R1 = V                                        |
| 0x10        | ST R1, R2   | Нет      | Нет              | Нет                   | MEM\[R2\] = R1                                |
| 0x11        | ST R1, V    | Да       | Нет              | Нет                   | MEM\[V\] = R1                                 |
| 0x12        | LD R1, R2   | Нет      | Нет              | R1                    | R1 = MEM\[R2\]                                |
| 0x13        | LD R1, V    | Да       | Нет              | R1                    | R1 = MEM\[V\]                                 |
| 0x14        | PUSH R1     | Нет      | Нет              | SP                    | Помещяет R1 в стек                            |
| 0x15        | POP R1      | Нет      | Нет              | SP                    | Извлекает R1 из стека                         |
| 0x16        | JMP R1      | Нет      | Нет              | PC                    | PC = R1                                       |
| 0x17        | JMP V       | Да       | Нет              | PC                    | PC = V                                        |
| 0x18        | JZ R1       | Нет      | Нет              | PC                    | Если ZF, то PC = R1                           |
| 0x19        | JZ V        | Да       | Нет              | PC                    | Если ZF, то PC = V                            |
| 0x1A        | JC R1       | Нет      | Нет              | PC                    | Если OF, то PC = R1                           |
| 0x1B        | JC V        | Да       | Нет              | PC                    | Если OF, то PC = V                            |
| 0x1C        | JNZ R1      | Нет      | Нет              | PC                    | Если !ZF, то PC = R1                          |
| 0x1D        | JNZ V       | Да       | Нет              | PC                    | Если !ZF, то PC = V                           |
| 0x1E        | JNC R1      | Нет      | Нет              | PC                    | Если !OF, то PC = R1                          |
| 0x1F        | JNC V       | Да       | Нет              | PC                    | Если !OF, то PC = V                           |
| 0x20        | PUSHA       | Нет      | Нет              | SP                    | Помещяет регистры все регистры в стек[^pusha] |
| 0x21        | POPA        | Нет      | Нет              | A, B, C, D, Flags, SP | Извлекает все регистры из стека[^popa]        |
| 0x22        | CALL R1     | Нет      | Нет              | PC                    | Помещяет PC в стек и PC = R1                  |
| 0x23        | CALL V      | Да       | Нет              | PC                    | Помещяет PC в стек и PC = V                   |
| 0x24        | RET         | Нет      | Нет              | PC                    | Извлекает PC из стека                         |
| 0x25        | XCNG R1, R2 | Нет      | Нет              | R1, R2                | Меняет R1 и R2 местами                        |

[^pusha]:
    Регистры помещяются в таком порядке: `Flags`, `D`, `C`, `B`, `A`
[^popa]:
    Регистры извлекаются в таком порядке: `A`, `B`, `C`, `D`, `Flags`
